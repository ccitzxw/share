# 分布式锁
---
## 一 基于setnx实现
redis没有像mysql中的排它锁，但是可以通过一些方式实现排它锁的功能，setnx实现了exists和set两个指令的功能，若给定的key已存在，则setnx不做任何动作，返回0；若key不存在，则执行类似set的操作，返回1。
## 二 基于zookeeper临时顺序节点实现
### 2.1 实现原理
基于[临时顺序节点](/markdown/distributed/zookeeper.md)的机制和在节点上注册上子节点变更通知的Watcher实现锁机制
### 2.2 锁机制创建过程
|实现锁机制顺序|
|:-|
|(1)客户端调用create()方法创建名为“locknode/guid-lock-”的节点(类型需要设置为EPHEMERAL_SEQUENTIAL)|
|(2)客户端调用getChildren(“locknode”)方法来获取所有已经创建的子节点，同时在这个节点上注册上子节点变更通知的[Watcher](/markdown/distributed/zookeeper.md)|
|(3)客户端获取到所有子节点path之后，如果发现自己在步骤1中创建的节点是所有节点中序号最小的，那么就认为这个客户端获得了锁。如果在步骤3中发现自己并非是所有子节点中最小的，说明自己还没有获取到锁，就开始等待，直到下次子节点变更通知的时候，再进行子节点的获取，判断是否获取锁|
### 2.3 利用临时顺序节点实现共享锁的改进实现
对于加锁操作，可以让所有客户端都去/lock目录下创建临时顺序节点，如果创建的客户端发现自身创建节点序列号是/lock/目录下最小的节点，则获得锁。否则，监视比自己创建节点的序列号小的节点（比自己创建的节点小的最大节点），进入等待
